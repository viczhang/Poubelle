{% extends "base.html" %}

{% block title %}Upload Images - {{ config.SITE_TITLE }}{% endblock %}

{% block content %}
<h1 class="h2 mb-5">Upload Images</h1>
<div class="card">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="title" class="form-label">Share Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password Protection (optional)</label>
                <input type="password" class="form-control" id="password" name="password">
                <div class="form-text">Leave blank to make the share accessible without a password.</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Images</label>
                <input type="file" class="form-control d-none" id="file-input" name="images" multiple accept="image/*">
                <div class="d-grid gap-2 mb-3">
                    <button type="button" id="add-files-btn" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> Add Images
                    </button>
                </div>
                <div class="form-text mb-2">Maximum 10 images per share, 5MB per image</div>
                <div id="file-list" class="mt-2"></div>
            </div>
            <div class="d-grid">
                <button type="submit" id="submit-btn" class="btn btn-primary" disabled>Create Share</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file-input');
        const addFilesBtn = document.getElementById('add-files-btn');
        const fileList = document.getElementById('file-list');
        const submitBtn = document.getElementById('submit-btn');
        let selectedFiles = [];
        
        // Maximum files allowed
        const MAX_FILES = 10;
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        
        // Update submit button state
        function updateSubmitButton() {
            submitBtn.disabled = selectedFiles.length === 0;
        }
        
        // Display file information
        function displayFile(file) {
            const fileSize = (file.size / 1024).toFixed(2);
            const fileItem = document.createElement('div');
            fileItem.className = 'd-flex align-items-center p-2 border rounded mb-2';
            fileItem.dataset.index = selectedFiles.length - 1;
            
            // Create file preview if it's an image
            let previewHtml = '<div class="flex-shrink-0 mr-3">';
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-thumbnail';
                    img.style.width = '80px';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    const previewDiv = fileItem.querySelector('.file-preview');
                    if (previewDiv) {
                        previewDiv.innerHTML = '';
                        previewDiv.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);
                previewHtml += '<div class="file-preview" style="width: 80px; height: 80px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">Loading...</div></div>';
            } else {
                previewHtml += '<div class="file-preview" style="width: 80px; height: 80px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;"><i class="bi bi-file-image"></i></div></div>';
            }
            
            fileItem.innerHTML = previewHtml + `
                <div class="flex-grow-1 mr-3">
                    <div class="font-weight-medium truncate" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</div>
                    <div class="text-sm text-muted">${fileSize} KB</div>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-file" data-index="${selectedFiles.length - 1}">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            fileList.appendChild(fileItem);
            
            // Add event listener to remove button
            fileItem.querySelector('.remove-file').addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                // Remove file from array
                selectedFiles.splice(index, 1);
                // Remove from UI
                fileItem.remove();
                // Update indexes for remaining files
                updateFileIndexes();
                // Update button state
                updateSubmitButton();
                // Enable add button if we removed below the limit
                if (selectedFiles.length < MAX_FILES) {
                    addFilesBtn.disabled = false;
                    addFilesBtn.classList.remove('btn-outline-secondary');
                    addFilesBtn.classList.add('btn-outline-primary');
                }
            });
        }
        
        // Update file indexes after removal
        function updateFileIndexes() {
            const fileItems = fileList.querySelectorAll('.border.rounded');
            fileItems.forEach((item, index) => {
                item.dataset.index = index;
                item.querySelector('.remove-file').dataset.index = index;
            });
        }
        
        // Handle file selection
        function handleFiles(files) {
            // Check how many files we can still add
            const remainingSlots = MAX_FILES - selectedFiles.length;
            let filesToAdd = Array.from(files).slice(0, remainingSlots);
            
            // Validate file sizes and types
            filesToAdd = filesToAdd.filter(file => {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File ${file.name} exceeds 5MB limit`);
                    return false;
                }
                return true;
            });
            
            // Add valid files
            filesToAdd.forEach(file => {
                selectedFiles.push(file);
                displayFile(file);
            });
            
            // Disable add button if we reached the limit
            if (selectedFiles.length >= MAX_FILES) {
                addFilesBtn.disabled = true;
                addFilesBtn.classList.remove('btn-outline-primary');
                addFilesBtn.classList.add('btn-outline-secondary');
            }
            
            // Update submit button
            updateSubmitButton();
        }
        
        // Trigger file input when add button is clicked
        addFilesBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Handle file input change
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFiles(this.files);
                // Reset file input to allow selecting the same files again
                this.value = '';
            }
        });
        
        // Create a custom FileList from selected files
        function createCustomFileList(files) {
            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            return dataTransfer.files;
        }
        
        // Modify form submission to include all selected files
        document.querySelector('form').addEventListener('submit', function(e) {
            // Replace the file input's files with our selected files
            fileInput.files = createCustomFileList(selectedFiles);
            // Form will submit normally with all files
        });
    });
</script>
{% endblock %}
